<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Another Office Picklist â€“ Transfer Tasks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, sans-serif;
      background: #f7fafc;
      color: #1a202c;
      padding: 16px;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(15, 23, 42, 0.1);
      padding: 16px;
    }

    h1 {
      font-size: 1.2rem;
      margin-bottom: 8px;
    }

    .subtitle {
      font-size: 0.85rem;
      color: #4a5568;
      margin-bottom: 12px;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
      align-items: center;
    }

    .filters select,
    .filters input,
    .filters button {
      font-size: 0.8rem;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
      background: #f9fafb;
    }

    .filters button {
      background: #3182ce;
      color: #fff;
      border: none;
      cursor: pointer;
    }

    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      max-height: 70vh;
      overflow-y: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    thead {
      position: sticky;
      top: 0;
      background: #edf2f7;
      z-index: 1;
    }

    th,
    td {
      padding: 6px 8px;
      border-bottom: 1px solid #e2e8f0;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      font-size: 0.78rem;
      color: #4a5568;
    }

    tr:nth-child(even) td {
      background: #f9fafb;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 500;
    }

    .badge-pending {
      background: #fed7d7;
      color: #9b2c2c;
    }

    .badge-partial {
      background: #fefcbf;
      color: #744210;
    }

    .badge-fulfilled {
      background: #c6f6d5;
      color: #22543d;
    }

    .qty-input {
      width: 70px;
      padding: 4px 6px;
      font-size: 0.78rem;
      border-radius: 6px;
      border: 1px solid #cbd5e0;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 0.75rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }

    .btn-update {
      background: #38a169;
      color: #fff;
    }

    .btn-refresh {
      background: #4a5568;
      color: #fff;
    }

    .status-bar {
      margin-top: 8px;
      font-size: 0.78rem;
      color: #4a5568;
    }

    @media (max-width: 640px) {
      .container {
        padding: 12px;
      }

      h1 {
        font-size: 1rem;
      }

      .filters {
        flex-direction: column;
        align-items: flex-start;
      }

      .filters > * {
        width: 100%;
      }

      .qty-input {
        width: 60px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Another Office Picklist</h1>
    <div class="subtitle">
      See all products assigned from main warehouse. Update how many units
      you brought and mark tasks fulfilled.
    </div>

    <div class="filters">
      <select id="statusFilter">
        <option value="">All statuses</option>
        <option value="pending">Pending</option>
        <option value="partial">Partial</option>
        <option value="fulfilled">Fulfilled</option>
      </select>

      <select id="dateRange">
        <option value="today">Today</option>
        <option value="yesterday">Yesterday</option>
        <option value="7d">Last 7 days</option>
        <option value="30d">Last 30 days</option>
        <option value="all">All time</option>
      </select>

      <button id="applyFilters">Apply</button>
      <button id="refreshBtn" class="btn-refresh">Refresh</button>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Picklist ID</th>
            <th>SKU</th>
            <th>Product</th>
            <th>Assigned Qty</th>
            <th>Brought / Fulfilled Qty</th>
            <th>Remaining</th>
            <th>Status</th>
            <th>Update</th>
          </tr>
        </thead>
        <tbody id="tasksBody">
          <!-- rows injected via JS -->
        </tbody>
      </table>
    </div>

    <div class="status-bar" id="statusBar"></div>
  </div>

  <script>
    const statusFilterEl = document.getElementById("statusFilter");
    const dateRangeEl = document.getElementById("dateRange");
    const applyFiltersBtn = document.getElementById("applyFilters");
    const refreshBtn = document.getElementById("refreshBtn");
    const tasksBody = document.getElementById("tasksBody");
    const statusBar = document.getElementById("statusBar");

    function getRangeTimestamps(rangeKey) {
      const now = new Date();
      const end = new Date(now);
      let start = null;

      if (rangeKey === "today") {
        start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      } else if (rangeKey === "yesterday") {
        const y = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        y.setDate(y.getDate() - 1);
        start = y;
        end.setFullYear(y.getFullYear(), y.getMonth(), y.getDate());
        end.setHours(23, 59, 59, 999);
      } else if (rangeKey === "7d") {
        start = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      } else if (rangeKey === "30d") {
        start = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
      } else {
        // all
        return { from: null, to: null };
      }

      return { from: start.getTime(), to: end.getTime() };
    }

    async function loadTasks() {
      const status = statusFilterEl.value;
      const rangeKey = dateRangeEl.value;
      const { from, to } = getRangeTimestamps(rangeKey);

      const params = new URLSearchParams();
      if (status) params.set("status", status);
      if (from) params.set("from", String(from));
      if (to) params.set("to", String(to));

      const url = "/transfer-tasks" + (params.toString() ? "?" + params.toString() : "");

      statusBar.textContent = "Loading tasks...";
      tasksBody.innerHTML = "";

      try {
        const res = await fetch(url);
        const data = await res.json();

        if (!res.ok) {
          statusBar.textContent = "Failed to load tasks: " + (data.error || "Unknown error");
          return;
        }

        if (!Array.isArray(data) || data.length === 0) {
          statusBar.textContent = "No tasks found for selected filters.";
          return;
        }

        renderTasks(data);
        statusBar.textContent = `Loaded ${data.length} task(s).`;
      } catch (err) {
        console.error(err);
        statusBar.textContent = "Error loading tasks.";
      }
    }

    function statusBadge(status) {
      const span = document.createElement("span");
      span.classList.add("badge");
      if (status === "fulfilled") span.classList.add("badge-fulfilled");
      else if (status === "partial") span.classList.add("badge-partial");
      else span.classList.add("badge-pending");

      span.textContent =
        status === "fulfilled"
          ? "Fulfilled"
          : status === "partial"
          ? "Partial"
          : "Pending";
      return span;
    }

    function renderTasks(list) {
      tasksBody.innerHTML = "";

      list.forEach((task, index) => {
        const tr = document.createElement("tr");

        const assigned = Number(task.assignedQty || 0);
        const fulfilled = Number(task.fulfilledQty || 0);
        const remaining = Math.max(assigned - fulfilled, 0);

        const tdIndex = document.createElement("td");
        tdIndex.textContent = String(index + 1);

        const tdPicklist = document.createElement("td");
        tdPicklist.textContent = task.picklistId || "-";

        const tdSku = document.createElement("td");
        tdSku.textContent = task.sku || "-";

        const tdProduct = document.createElement("td");
        tdProduct.textContent = task.product || "-";

        const tdAssigned = document.createElement("td");
        tdAssigned.textContent = assigned;

        const tdFulfilled = document.createElement("td");
        const input = document.createElement("input");
        input.type = "number";
        input.min = "0";
        input.step = "1";
        input.value = fulfilled;
        input.className = "qty-input";
        tdFulfilled.appendChild(input);

        const tdRemaining = document.createElement("td");
        tdRemaining.textContent = remaining;

        const tdStatus = document.createElement("td");
        tdStatus.appendChild(statusBadge(task.status || "pending"));

        const tdUpdate = document.createElement("td");
        const btn = document.createElement("button");
        btn.textContent = "Update";
        btn.className = "btn-small btn-update";
        btn.addEventListener("click", async () => {
          const newVal = Number(input.value);
          if (Number.isNaN(newVal) || newVal < 0) {
            alert("Please enter a valid non-negative number.");
            return;
          }

          try {
            const res = await fetch(`/transfer-tasks/${task.id}`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ fulfilledQty: newVal }),
            });
            const data = await res.json();
            if (!res.ok) {
              alert("Failed to update task: " + (data.error || "Unknown"));
              return;
            }

            alert("Task updated. Status: " + data.status);
            loadTasks();
          } catch (err) {
            console.error(err);
            alert("Error updating task.");
          }
        });
        tdUpdate.appendChild(btn);

        tr.appendChild(tdIndex);
        tr.appendChild(tdPicklist);
        tr.appendChild(tdSku);
        tr.appendChild(tdProduct);
        tr.appendChild(tdAssigned);
        tr.appendChild(tdFulfilled);
        tr.appendChild(tdRemaining);
        tr.appendChild(tdStatus);
        tr.appendChild(tdUpdate);

        tasksBody.appendChild(tr);
      });
    }

    applyFiltersBtn.addEventListener("click", loadTasks);
    refreshBtn.addEventListener("click", loadTasks);

    // Default: show today's pending tasks
    statusFilterEl.value = "pending";
    dateRangeEl.value = "today";
    loadTasks();
  </script>
</body>
</html>
